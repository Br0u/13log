{{- $target := .Params.link | default .Permalink }}
{{- $previewEnabled := site.Params.linkPreview | default true }}
{{- $title := .Title }}
{{- $desc := .Params.description | default (.Summary | plainify | htmlUnescape) }}
{{- $image := "" }}
{{- with .Params.image }}
  {{- if strings.HasPrefix . "http" }}
    {{- $image = . }}
  {{- else }}
    {{- $res := resources.Get . }}
    {{- if $res }}
      {{- $image = $res.RelPermalink }}
    {{- else }}
      {{- $image = . }}
    {{- end }}
  {{- end }}
{{- end }}
{{- $needsAsyncPreview := and $previewEnabled (or (not $image) (not $desc)) }}
<div
  class="link-board-card{{ if $needsAsyncPreview }} link-board-card--preview-pending{{ end }}"
  data-link-card
  data-preview-enabled="{{ if $previewEnabled }}true{{ else }}false{{ end }}"
  data-preview-url="{{ $target }}"
>
  <a class="link-board-card__main" href="{{ $target }}" target="_blank" rel="noopener">
    <div class="link-board-card__preview{{ if not $image }} is-empty{{ end }}" data-preview-container>
      {{- if $image }}
      <img src="{{ $image }}" alt="" loading="lazy" decoding="async" data-preview-image>
      {{- end }}
    </div>
    <div class="link-board-card__title" data-preview-title>{{ $title }}</div>
    <div class="link-board-card__desc{{ if not $desc }} is-empty{{ end }}" data-preview-desc>{{ $desc }}</div>
    {{- if .Params.site }}
    <div class="link-board-card__meta">{{ .Params.site }}</div>
    {{- end }}
  </a>

  {{- with .Params.children }}
  <div class="link-board-children">
    {{- range . }}
    <a class="link-board-child" href="{{ .link }}" target="_blank" rel="noopener">
      <div class="link-board-child__title">{{ .title }}</div>
      {{- if .description }}
      <div class="link-board-child__desc">{{ .description }}</div>
      {{- end }}
    </a>
    {{- end }}
  </div>
  {{- end }}
</div>
